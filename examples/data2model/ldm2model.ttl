@prefix localupdatestage: <http://localhost:8080/data2model/update/>.
@prefix updatestage: <http://linkeddata.ordina.nl/data2model/update/>.
@prefix stage: <http://localhost:8080/data2model/stage#>.
@prefix elmo: <http://bp4mc2.org/elmo/def#>.
@prefix html: <http://www.w3.org/1999/xhtml/vocab#>.
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#>.

#Production for local installations
localupdatestage:ldm2model a elmo:Production;
	elmo:contains stage:HeaderAppearance;
	elmo:contains stage:Menu;
	elmo:contains stage:ldm2model_scene1;
	elmo:contains stage:ldm2model_scene2;
	elmo:contains stage:ldm2model_scene3;
	elmo:contains stage:ldm2model_scene4;
	elmo:contains stage:ldm2model_scene5;
	elmo:contains stage:ldm2model_scene6;
	elmo:contains stage:ldm2model_scene7;
.

#Production for server installations
updatestage:ldm2model a elmo:Production;
	elmo:contains stage:HeaderAppearance;
	elmo:contains stage:Menu;
	elmo:contains stage:ldm2model_scene1;
	elmo:contains stage:ldm2model_scene2;
	elmo:contains stage:ldm2model_scene3;
	elmo:contains stage:ldm2model_scene4;
	elmo:contains stage:ldm2model_scene5;
	elmo:contains stage:ldm2model_scene6;
	elmo:contains stage:ldm2model_scene7;
  # Extra for copy of result
  elmo:contains stage:ldm2model_xxclearservergraph;
  elmo:contains stage:ldm2model_xxcopytoservergraph;
.

stage:ldm2model_xxclearservergraph a elmo:Scene;
  elmo:index "98";
  rdfs:label "Clear server graph";
  elmo:query "clear graph <http://linkeddata.ordina.nl/data2model/container/model>";
.
stage:ldm2model_xxcopytoservergraph a elmo:Scene;
  elmo:index "99";
  rdfs:label "Copy result to server graph";
  elmo:query '''
    insert into <http://linkeddata.ordina.nl/data2model/container/model> {
      ?s ?p ?o
    }
    where {
      graph <http://localhost:8080/data2model/container/model> {
        ?s ?p ?o
      }
    }
  '''
.

stage:ldm2model_scene1 a elmo:Scene;
	elmo:index "01";
	rdfs:label "Clear target graph";
	elmo:query "clear graph <http://localhost:8080/data2model/container/model>";
.

stage:ldm2model_scene2 a elmo:Scene;
	elmo:index "02";
	rdfs:label "Create technical names";
	elmo:query '''
		PREFIX ldm: <http://powerdesigner.com/def#>
		PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
		insert into <http://localhost:8080/data2model/container/model> {
			?item skos:notation ?codefixed.
		}
		where {
			graph <http://localhost:8080/data2model/container/data> {
				?item ldm:code ?code
				BIND (replace(?code,"[^a-zA-Z0-9_-]","_") as ?codefixed)
			}
		}
	''';
.

stage:ldm2model_scene3 a elmo:Scene;
	elmo:index "03";
	rdfs:label "Add technical name when missing";
	elmo:query '''
		insert into <http://localhost:8080/data2model/container/model> {
			?item skos:notation ?localname.
		}
		where {
			graph <http://localhost:8080/data2model/container/data> {
				?item a ?type.
				BIND (strafter(str(?item),":") as ?localname)
			}
			filter not exists {
				graph <http://localhost:8080/data2model/container/model> {
					?item skos:notation ?code
				}
			}
		}
	''';
.

stage:ldm2model_scene4 a elmo:Scene;
	elmo:index "04";
	rdfs:label "Add ldm:Entities";
	elmo:query '''
	  PREFIX ldm: <http://powerdesigner.com/def#>
		PREFIX sh: <http://www.w3.org/ns/shacl#>
    insert into <http://localhost:8080/data2model/container/model> {
			?entity rdf:type sh:NodeShape.
			?entity rdfs:label ?entitylabel.
			?entity sh:name ?code.
			?entity sh:targetClass ?class.
			?class rdf:type owl:Class.
			?class rdfs:label ?entitylabel.
			?class rdfs:comment ?comment.
    }
    where {
      graph <http://localhost:8080/data2model/container/data> {
        ?entity rdf:type ldm:Entity.
        ?entity rdfs:label ?entitylabel.
				?entity ldm:code ?code.
				OPTIONAL {?entity ldm:comment ?comment}
      }
			graph <http://localhost:8080/data2model/container/model> {
				?entity skos:notation ?notation
				BIND (iri(concat("http://linkeddata.ordina.nl/ldm/def#",ucase(substr(?notation,1,1)),lcase(substr(?notation,2)))) as ?class)
			}
    }
  ''';
.

stage:ldm2model_scene5 a elmo:Scene;
	elmo:index "05";
	rdfs:label "Add ldm:Attributes";
	elmo:query '''
	  PREFIX ldm: <http://powerdesigner.com/def#>
		PREFIX sh: <http://www.w3.org/ns/shacl#>
    insert into <http://localhost:8080/data2model/container/model> {
			?entity sh:property ?attribute.
			?attribute rdf:type sh:PropertyShape.
			?attribute rdfs:label ?attributelabel.
			?attribute sh:name ?code.
			?attribute sh:path ?property.
      ?property rdf:type owl:DatatypeProperty.
      ?property rdfs:label ?attributelabel.
			?property rdfs:comment ?comment.
    }
    where {
      graph <http://localhost:8080/data2model/container/data> {
				?entity rdf:type ldm:Entity.
				?entity ldm:attribute ?attribute.
        ?attribute rdf:type ldm:Attribute.
        ?attribute rdfs:label ?attributelabel.
				?attribute ldm:code ?code.
				OPTIONAL {?attribute ldm:comment ?comment}
      }
			graph <http://localhost:8080/data2model/container/model> {
				?attribute skos:notation ?notation
				BIND (iri(concat("http://linkeddata.ordina.nl/ldm/def#",lcase(?notation))) as ?property)
			}
    }
  ''';
.

stage:ldm2model_scene6 a elmo:Scene;
	elmo:index "06";
	rdfs:label "Add ldm:Relationship";
	elmo:query '''
	  PREFIX ldm: <http://powerdesigner.com/def#>
		PREFIX sh: <http://www.w3.org/ns/shacl#>
    insert into <http://localhost:8080/data2model/container/model> {
			?entity sh:property ?relationship.
			?relationship rdf:type sh:PropertyShape.
			?relationship rdfs:label ?relationshiplabel.
			?relationship sh:name ?code.
			?relationship sh:path ?property.
			?relationship sh:class ?refclass.
      ?property rdf:type owl:ObjectProperty.
      ?property rdfs:label ?relationshiplabel.
			?property rdfs:comment ?comment.
    }
    where {
      graph <http://localhost:8080/data2model/container/data> {
				?relationship rdf:type ldm:Relationship.
				?relationship ldm:object1entity ?entity.
				?relationship ldm:object2entity ?entity2.
        ?relationship rdfs:label ?relationshiplabel.
				?relationship ldm:code ?code.
				OPTIONAL {?entity ldm:comment ?comment}
      }
			graph <http://localhost:8080/data2model/container/model> {
				?relationship skos:notation ?notation
				BIND (iri(concat("http://linkeddata.ordina.nl/ldm/def#",lcase(?notation))) as ?property)
			}
			graph <http://localhost:8080/data2model/container/model> {
				# Link to the original entities (not nodes) via hack:
				?entity2 sh:targetClass ?refclass.
			}
    }
  ''';
.

stage:ldm2model_scene7 a elmo:Scene;
	elmo:index "07";
	rdfs:label "Add ldm:Inheritances";
	elmo:query '''
	  PREFIX ldm: <http://powerdesigner.com/def#>
		PREFIX sh: <http://www.w3.org/ns/shacl#>
    insert into <http://localhost:8080/data2model/container/model> {
			?subclass rdfs:subClassOf ?superclass
    }
    where {
      graph <http://localhost:8080/data2model/container/data> {
				?inheritance rdf:type ldm:Inheritance.
				?inheritance ldm:parentEntity ?parententity.
				?inheritancelink ldm:object1inheritance ?inheritance.
				?inheritancelink ldm:object2entity ?entity.
      }
			graph <http://localhost:8080/data2model/container/model> {
				# Link to the original entities (not nodes) via hack:
				?parententity sh:targetClass ?superclass.
				?entity sh:targetClass ?subclass.
			}
    }
  ''';
.
